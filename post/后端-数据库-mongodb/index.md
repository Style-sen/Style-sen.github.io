# 后端-数据库-MONGODB


# 基础概念
1. 关系型数据库遵循A（原子性）C（一致性）I（独立性）D（持久性）规则。
3. MongoDB是一个基于`分布式文件存储`(基于磁盘的)的数据库。由C++语言编写。旨在为WEB应用提供可扩展的高性能数据存储解决方案。
4. MongoDB是一个介于关系数据库和非关系数据库(nosql)之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。
5. MongoDB支持的数据结构非常松散。类似json的bson格式。查询语言强大。

## NoSQL
1. NoSQL用于超大规模数据的存储。

### 分类
1. key-value：redis
2. 文档型：mongoDb
3. 图数据库：neo4j
4. 列存储数据库，HBASE

## 概念

SQL术语/概念|	MongoDB术语/概念|	解释/说明
--|--|--
database|	database|	数据库
table|	collection|	数据库表/集合
row	|document|	数据记录行/文档
column|	field|	数据字段/域
index|	index	索引
table joins||	 	表连接,MongoDB不支持
primary key|	primary key	|主键,MongoDB自动将_id字段设置为主键

1. 一个mongodb中可以建立多个数据库。
2. MongoDB的默认数据库为"db"，该数据库存储在data目录中。
3. MongoDB的单个实例可以容纳多个独立的数据库，每一个都有自己的集合和权限，不同的数据库也放置在不同的文件中

RDBMS|	MongoDB
--|--
数据库|	数据库
表格|	集合
行|	文档
列|	字段
表联合|	嵌入文档
主键|	主键 (MongoDB 提供了 key 为 _id )

## 数据类型

数据类型|	描述
--|--
String	|字符串。存储数据常用的数据类型。在 MongoDB 中，UTF-8 编码的字符串才是合法的。
Integer	|整型数值。用于存储数值。根据你所采用的服务器，可分为 32 位或 64 位。
Boolean	|布尔值。用于存储布尔值（真/假）。
Double	|双精度浮点值。用于存储浮点值。
Min/Max keys	|将一个值与 BSON（二进制的 JSON）元素的最低值和最高值相对比。
Array	|用于将数组或列表或多个值存储为一个键。
Timestamp	|时间戳。记录文档修改或添加的具体时间。
Object	|用于内嵌文档。
Null	|用于创建空值。
Symbol	|符号。该数据类型基本上等同于字符串类型，但不同的是，它一般用于采用特殊符号类型的语言。
Date	|日期时间。用 UNIX 时间格式来存储当前日期或时间。你可以指定自己的日期时间：创建 Date 对象，传入年月日信息。
Object ID	|对象 ID。用于创建文档的 ID。
Binary Data	|二进制数据。用于存储二进制数据。
Code	|代码类型。用于在文档中存储 JavaScript 代码。
Regular expression	|正则表达式类型。用于存储正则表达式。 

# 应用场景

1. `一般用于静态数据的场合，事务性的场合（完整的业务流）不适用`。
2. Mongo 适用于以下场景:

    a. 网站数据：Mongo 非常适合实时的插入，更新与查询，并具备网站实时数据存储所需的复制及高度伸缩性。
    b. 缓存：由于性能很高，Mongo 也适合作为信息基础设施的缓存层。在系统重启之后，由Mongo 搭建的持久化缓存层可以避免下层的数据源过载。
    c. 大尺寸、低价值的数据：使用传统的关系型数据库存储一些数据时可能会比较昂贵，在此之前，很多时候程序员往往会选择传统的文件进行存储。
    d. 高伸缩性的场景：Mongo 非常适合由数十或数百台服务器组成的数据库，Mongo 的路线图中已经包含对MapReduce 引擎的内置支持。
    e. 用于对象及JSON 数据的存储：Mongo 的BSON 数据格式非常适合文档化格式的存储及查询。

3. MongoDB 的使用也会有一些限制，例如，它不适合于以下几个地方。

    a. 高度事务性的系统：例如，银行或会计系统。传统的关系型数据库目前还是更适用于需要大量原子性复杂事务的应用程序。
    b. 传统的商业智能应用：针对特定问题的BI 数据库会产生高度优化的查询方式。对于此类应用，数据仓库可能是更合适的选择。
    c. 需要SQL 的问题。复杂的跨文档（表）级联查询。

## 游戏场景
1. 使用 MongoDB 存储游戏`用户信息`，用户的装备、积分等直接以`内嵌文档`的形式存储，方便查询、更新。

## 物流场景
1. 使用 MongoDB 存储`订单信息`，订单状态在运送过程中会不断更新，以 MongoDB `内嵌数组`的形式来存储，一次查询就能将订单所有的变更读取出来。

## 社交场景
1. 使用 MongoDB 存储`用户信息`，以及用户发表的`朋友圈信息`，通过`地理位置索引实现附近的人、地点`等功能。

## 物联网场景
1. 使用 MongoDB 存储所有接入的`智能设备信息，以及设备汇报的日志信息`，并对这些信息进行多维度的分析

## 视频直播
1. 使用 MongoDB 存储用户信息、礼物信息等。

## 其他
1. 2个及以上yes。

应用特征|	Yes / No
--|--
`应用不需要事务及复杂 join 支持` |	必须 Yes
新应用，需求会变，数据模型无法确定|想快速迭代开发	？
应用需要2000-3000以上的读写QPS（更高也可以）|	？
应用需要TB甚至 PB 级别数据存储	|?
应用发展迅速，需要能快速水平扩展	|?
应用要求存储的数据不丢失|	?
应用需要99.999%高可用	|?
应用需要大量的地理位置查询、文本查询|	？

# 使用

## 启动
1. MongoDB的数据存储在data目录的db目录下，但是这个目录在安装过程不会自动创建，所以你需要手动创建data目录，并在data目录中创建db目录。
2. 注意：/data/db 是 MongoDB 默认的启动的数据库路径(--dbpath)。
### 前台启动
### 后台启动
1. `--fork`
### 使用配置文件启动
1. `--config mongo.conf`指定配置文件。
2. 参考[MongoDB 通过配置文件启动](https://blog.csdn.net/tianwei7518/article/details/44261235).

## 停止

### 查看进程，使用kill命令；不能使用kill -9
### 在客户端进去，使用shutdown命令
```
> use admin;
switched to db admin
> db.shutdownServer();
server should be down...
```
1. 在主节点（primary）上运行shutdown命令时，服务器在关闭之前，会先等待备份节点追赶主节点以保持同步。这将回滚的可能性降至最低，但shutdown操作有失败的可能性。如几秒钟内没有备份节点成功同步，则shutdown操作失败，主节点不会停止运行。

## 日志

1. 在启动mongod的时候，可以指定日志的级别，即（-v、-vv、-vvv、-vvvv、-vvvvv）或者在shell命令行执行命令修改`mongodb/bin/mongod --dbpath mongodb/0707 --directoryperdb --fork -vvv` 日志级别越大，输出的日志越详细，调至5时，这时mongod会在日志中记录几乎所有的操作，包括每一个请求所处理的内容。
 2. MongoDB默认记录耗时超过100毫秒的查询信息。如果100毫秒不适合需求，可以通过setProfilingLevel命令来改变，下面这条命令表示记录查询时间超过500毫秒的消息
 ```
    > db.setProfilingLevel(1,500)
    { "was" : 0, "slowms" : 100, "ok" : 1 }
 ```
3. 如果想要日志分割，如按天存放，有两种方法
方法一：每天定时的执行kill -USR1 进程号，这样就可以看到，每执行一次kill -USR1 进程号，那么就会重新生成一个日志文件
方法二：在MongoDB的shell行执行，每执行一次都会产生一个新的日志文件
```
    > db.adminCommand({"logRotate":1})
    { "ok" : 1 }
 ```
 要使分割日志生效，必须启动的时候使用--logpath，然后可以根据自己的需求，写shell或python脚本，然后crontab做成定时任务
 
 
