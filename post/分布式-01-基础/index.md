# 分布式-01-基础


## CAP

1. 分布式系统的核心是`可扩展性`，通过对服务、存储的扩展，来提高系统的处理能力，通过对多台服务器协同工作，来完成单台服务器无法处理的任务，尤其是高并发或者大数据量的任务。
2. 除了对可扩展性的需求，分布式系统还有不出现单点故障、服务或者存储无状态等特点。
3. CAP 理论可以表述为，一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容忍性（Partition Tolerance）这三项中的两项。
4. 在分布式系统中，由于系统的各层拆分，`P 是确定的`，CAP 的应用模型就是 CP 架构和 AP 架构。分布式系统所关注的，就是在 Partition Tolerance 的前提下，如何实现更好的 A，和更稳定的 C。

### 应用

1. 不要把精力浪费在如何设计能满足三者的完美分布式系统上，而要合理进行取舍。
2. 不同业务对于一致性的要求是不同的。
3. CAP 理论中是忽略网络延迟的。

### AP和CP的取舍

1. 如何在保持`相对一致性`的前提下，提高系统的可用性。
2. ZooKeeper 是 CP（`CP指的是写数据之后，要花时间去同步数据，使各处的数据一致，期间不可用,强一致，低可用`）。
3. `很多分布式系统设计时的选择是AP`，如BASE。
4. Eureka 是 Spring Cloud 微服务技术栈中的服务发现组件，是AP架构。

## BASE

1. 在工程实践中，基于 CAP 定理逐步演化，就提出了 Base 理论（比如 NoSQL 系统、微服务架构）。
2. Base 是三个短语的简写，即基本可用（Basically Available）、软状态（Soft State）和`最终一致性（Eventually Consistent）`。

### 基本可用

1. 强调了分布式系统在出现不可预知故障的时候，允许损失部分可用性，相比正常的系统，可能是响应时间延长，或者是`服务被降级`（主要的服务正常）。
2. 秒杀中的限流、降级.

### 软状态

1. 软状态可以对应 ACID 事务中的原子性（硬状态）。
2. 允许系统中的数据存在中间状态（比如支付中...），允许系统在多个不同节点的数据副本存在数据延时。

### 最终一致性

1. 数据必须在一个时间期限之后达到各个节点的一致性。
2. 重试、补偿等方式.

## ACID

1. ACID 是一种强一致性模型，强调原子性、一致性、隔离性和持久性，主要用于在数据库实现中。
2. Base 理论面向的是高可用、可扩展的分布式系统，ACID 适合传统金融等业务，在实际场景中，不同业务对数据的一致性要求不一样，ACID 和 Base 理论往往会结合使用。

## 全局时钟和逻辑时钟

1. `多节点的时间同步问题`：不同机器上的物理时钟难以同步，导致无法区分在分布式系统中多个节点的事件时序。
2. 问题的关键点在于节点间的交互要在`事件的发生顺序`上达成一致，而不是对于时间达成一致。

## 数据一致性模型(外部一致性)

1. 数据一致性模型可以分为强一致性和弱一致性，除此以外，所有其他的一致性都是弱一致性的特殊情况。
2. `在互联网领域的绝大多数场景中，都需要牺牲强一致性来换取系统的高可用性，系统往往只需要保证“最终一致性”，只要这个最终时间是在用户可以接受的范围内即可`。

### 强一致性

### 弱一致性

1. 不一致性窗口。

### 最终一致性

1. 最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性。

#### 因果一致性

1. 因果一致性要求有因果关系的操作顺序得到保证，非因果关系的操作顺序则无所谓。例如评论回复。

#### 会话一致性

1. 约定了系统能保证在同一个有效的会话中实现“读己之所写”的一致性，就是在你的一次访问中，执行更新操作之后，客户端能够在同一个会话中始终读取到该数据项的最新值。
2. 分布式的 Session 一致性问题。

## Paxos
1. 开源分布式锁组件 Google Chubby 的作者 Mike Burrows 说过，这个世界上只有一种一致性算法，那就是 Paxos 算法，其他的算法都是残次品。

### Quorum 机制
1. 在各种一致性算法中都可以看到Quorum 机制的身影，主要数学思想来源于抽屉原理。
2. 用一句话解释那就是，在 N 个副本中，一次更新成功的如果有 W 个，那么我在读取数据时是要从大于 N－W 个副本中读取，这样就能至少读到一个更新的数据了。
3. 和 Quorum 机制对应的是 WARO，也就是Write All Read one，是一种简单的副本控制协议，当 Client 请求向某副本写数据时（更新数据），只有当所有的副本都更新成功之后，这次写操作才算成功，否则视为失败。


