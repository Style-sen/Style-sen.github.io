# 嵌入式-MESH


参考[什么是Mesh网络](https://www.jianshu.com/p/ce56f75284b8)

## 1. 简介

1. 无线Mesh技术是一种与传统无线网络完全不同的新型无线网络技术。在传统的WLAN中，每个客户端均通过一条与接入点（AP）相连的无线链路访问网络，用户若要进行相互通信，必须首先访问一个固定的AP，这种网络结构称为单跳网络。而在无线Mesh网络中，任何无线设备节点都可同时作为路由器，网络中的每个节点都能发送和接收信号，每个节点都能与一个或多个对等节点进行直接通信。
2. 这种结构的最大好处在于：如果最近的AP由于流量过大而导致拥塞的话，数据可以自动重新路由到一个通信流量较小的邻近节点进行传输。依此类推，数据包还可以根据网络的情况，继续路由到与之最近的下一个节点进行传输，直到到达最终目的地为止。这样的访问方式就是多跳访问。

## 2. 特点

### 2.1. 自组织

网络节点和授权最终用户可即时加入网络，扩展网络覆盖范围，并可连接至所有其他节点。

### 2.2. 自愈

如果网络中的某台设备发生故障或从其拓扑位置上拆卸，网络会自动适应这种改变。既使发端与对端之间的连接涉及多台中继设备，网络也会找到从发端到对端的新的路由。

### 2.3. 多跳式

每个网络节点和用户端设备（无线通信单元）均能转发和路由发送至另一个对端的数据包，能选择并确定一个从发端到对端的最佳路由。

### 2.4. 点对点网络

自组织网络通常由平等的网元构成，只要发端和对端的距离足够近，就能直接连接发端和对端。而不必通过中央管理节点。

### 2.5. 多信道协商 提高带宽的利用率

无线Mesh网络进行多信道接入时一种协调机制，保证通信的两个节点都工作在相同的信道上。将时间轴被划分为信标间隔，在每一个信标间隔的开始，建立一个叫做ATIM的时间窗口，在相同的ATIM窗口内，有数据需要发送的节点使用控制消息和接收端使用相同的信道。这种多信道协商方法的目的是要选择业务负载小的信道，尽可能地平衡信道负载，减小竞争和退避所浪费的带宽。

## 3. 工作原理

### 3.1. Mesh邻居发现

Mesh发现是Mesh网络建立过程中的第一步，类似于接入服务中STA扫描网络。
#### 3.1.1. Mesh网络扫描
Mesh节点(MP)通过主动发送Probe Request探测帧，或侦听Beacon帧，来收集邻居信息。Beacon或Probe帧中包含Mesh ID、Mesh Configuration以及安全能力等相关信息。
#### 3.1.2. 邻居关系维护
MP从接收到的Beacon或Probe Response帧中解析发端MP的Mesh profile信息，与本端Mesh profile信息进行匹配。只有当扫描双方的Mesh profile`匹配`时，双方才可以建立邻居关系。

### 3.2. Mesh连接管理
Mesh连接管理包括Mesh连接建立和Mesh连接拆除两个过程，采用Peer Link Open/Confirm/Close三种Mesh连接管理Action帧交互实现。
#### 3.2.1. Mesh连接建立
MP在选出候选Peer后，可以与之发起Mesh连接建立过程。协商Mesh连接的双方需要确保使用相同的Mesh profile。
每个MP根据需要可以建立一条或多条Mesh连接，Mesh连接建立后，需要继续进行后续的认证和安全协商，之后Mesh连接才可以参与Mesh数据转发。
#### 3.2.2. Mesh连接拆除
Mesh连接双方中任一方，均可以主动向对方发送Peer Link Close消息，以关闭双方间的Mesh连接，收到Peer Link Close消息的MP，需要向对方MP回应一个Peer Link Close消息。

### 3.3. Mesh安全机制
由于传输媒质的开放性，无线网络很容易遭受非法攻击，802.11i标准的推出解决了传统WLAN网络的安全问题，但Mesh网络的多跳性带来了新的安全挑战。在认证方式上，Mesh安全同样支持802.1x认证和PSK认证方式，802.1x认证通过Supplicant MP与AAA server交互产生后续密钥协商用的种子密钥MSK，PSK认证方式则直接使用PSK作为密钥协商的种子密钥。

### 3.4. Mesh选路
Mesh网络是全连接的WLAN网络，任何一个源和目的地之间会存在多条可用的Mesh链路，并且这些Mesh链路的传输质量会随着周边环境实时变化。因此，非常有必要在Mesh网络支持选路协议，以确保数据帧能始终通过最优的链路传输。

### 3.5. Mesh转发
对于目的MAC为单播地址的数据帧，首先查找转发表项。若查到匹配表项，则将数据帧由该表项对应的Mesh链路发送出去；若未匹配任何表项，则将该数据帧从所有处于活跃状态的Mesh链路发送出去。
对于目的MAC为组播或广播地址的数据帧，MP将数据帧从所有处于活跃状态的Mesh链路发送出去。

## 4. 实现

### 4.1. [ESP MESH](https://www.espressif.com/zh-hans/products/software/esp-mesh/overview)
