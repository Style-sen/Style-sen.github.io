# Kubernetes-服务网格


阅读[Kubernetes 服务网格: Istio, Linkerd 和 Consul 大比较](http://www.helight.info/blog/2020/comparison-of-service-mesh/)

# 存在的问题

1. 目前越来越多的容器应用都是基于 Kubernetes 的，Kubernetes 已经成为了容器编排的事实标准。
2. 微服务架构带来的影响，其中之一就是为服务的延展。就像城市周围的郊区一样，部署的小服务数量在呈现几何增长，这也是微服务带来的灾难性问题之一。
3. 微服务的大量增加对如何统一标准化管理服务带来了非常大的挑战，比如多个服务/版本之间的路由、验证和授权、加密，以及在Kubernetes集群内的负载均衡等。

# 服务网格

1. 服务网格就是来帮助解决这些问题的，甚至可以有更多功能。就像容器把应用程序从操作系统上抽象出来，服务网格的目标就是把如何处理进程间通信再抽象出来。
2. 理解微服务最关键的一点就是要理解微服务都是严重依赖网络的。
3. 服务网格管理服务间的网络流量。
4. 服务网格层是在Kubernetes设施之上的，让服务间的网络通信安全可靠。
5. 服务网格可以通过可观测性，网络和安全策略来分隔应用程序的业务逻辑。通过服务网格可以链接微服务，让微服务更安全，并且可以更好的监控微服务。

## 连接
1. 通过服务网格服务可以发现其它服务，并且可以相互通信。它可以智能的路由控制使服务间的流量和API调用。同时也可以支持高级的不部署方式，比如蓝绿发布，金丝雀或者滚动升级，甚至更多。
## 安全
1. 服务网格可以让服务间进行安全通信。可以执行安全策略来允许或者拒绝通信，比如，可以配置一个策略来拒绝来自部署环境中的客户服务访问生产服务。
## 监控
1. 服务网格可以让分布式的微服务系统具有可观测性。服务网格通常集成开箱即用的监控和追踪工具（比如 Kubernetes 中的 Prometheus 和 Jaeger），这些工具可以发现并可视化服务、流量、API延迟和跟踪之间的依赖关系。

## 案例应用
1. 参考下面的例子，来看看如何利用服务网格技术，先不管应用的伸缩性哈。通过熟悉这些知识，就可以开始在系统设计中对服务网格进行标准化，以便为将来的大规模操作放置构建块和关键组件。

### 在分布式服务中改进可观测性
1. 让你有了服务级别的可视化，追踪和监控能力。服务网格的一些关键能力极大地提高了可视化，同时提高了解决和减少问题的能力。例如，如果系统中的一个服务成为了瓶颈，一般的做法就是重试，但是这会因为瓶颈服务超时而恶化服务能力。有了服务网格，就可以很轻松的断开失败的服务，以此来禁止无用的副本，从而保持 API 的相应。
### 蓝绿发布
2. 有流量控制的能力。服务网格可以实现蓝绿发布，从而让应用程序的升级无需终端的安全升级。首先，暴露一小部分用户到新的版本，然后验证，最后再继续将其发布到生产中的所有实例
### 生产环境中的混沌测试
3. 注入延时、故障的能力，可以帮助提升部署的鲁棒性。
### 对接已有应用程序
1. 如果你正在迁移现有的应用程序到基于 Kubernetes 的微服务上，可以使用服务网格作为桥接器而不用重写你的应用。可以把已有的应用程序作为 services 注册成为 Istio 的服务，然后开始逐步的迁移到 Kubernetes，而不用改变现在的服务间通信（像 DNS 路由）。这个案例和使用服务发现类似。
### API 网关
如果你对服务网格很感兴趣，并且打算使用，但是还没有使用 Kubernetes 的应用程序在跑，可以让你的运维团队部署服务网格来度量你的 API 使用，以此来学习使用服务网格。

# 开源的服务网格

## [Consul](https://www.consul.io/docs/internals/architecture.html)

## [Istio](https://istio.io/docs/concepts/what-is-istio/#architecture)

## [Linkerd](https://linkerd.io/2/reference/architecture/)

## 三者的区别

1. 目前为止 Istio 是 3 个技术方案中拥有最多的特性和灵活性的一个，但是要记住灵活性就意味着复杂性。
2. 如果只是支持 Kubernetes，那么 Linkerd 或许是最好的选择。如果你想支持多种环境（包括了 Kubernetes 和 VM 环境）但是又不需要 Istio 的复杂性，那么 Consul 可能是最好的选择。
3. Istio 正迅速的成为 Kubernetes 上的服务网格技术标准。它是最成熟，但是部署最复杂的。
4. [Istio和Linkerd的CPU基准测试](https://www.servicemesher.com/blog/benchmarking-istio-and-linkerd-cpu/)
